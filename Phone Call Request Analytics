-- Comparing prev. month to this month
with chat_requests AS 
(SELECT *, q.reviewtext as contact_preference, date(datetime(timestamp(dsaEvent.eventDatetime))) as date
FROM `rental-prod.nuuly_messages.cx_reviews_messages` 
join unnest(questions) q ON q.reviewtype IN ('contact-preference','contact-method') 
where date(datetime(timestamp(dsaEvent.eventDatetime))) between '2022-05-01' and '2022-06-30'
)
, contact_type_by_month as
(
select 
case 
  when cp = 'chat' and date between '2022-05-01' and '2022-05-31' then 'May chat'
  when cp = 'email' and date between '2022-05-01' and '2022-05-31' then 'May email'
  when cp = 'phone' and date between '2022-05-01' and '2022-05-31' then 'May phone'
  when cp = 'chat' and date between '2022-06-01' and '2022-06-30' then 'June chat'
  when cp = 'email' and date between '2022-06-01' and '2022-06-30' then 'June email'
  when cp = 'phone' and date between '2022-06-01' and '2022-06-30' then 'June phone'
end as contact_type, count(profileId) as total_reach_out_by_contact_type
from chat_requests , unnest(contact_preference) cp
group by contact_type  
)
select *,
case
  when contact_type like '%May%' then total_reach_out_by_contact_type/(select count(profileId) from chat_requests where date between '2022-05-01' and '2022-05-31')
  when contact_type like '%June%' then total_reach_out_by_contact_type/(select count(profileId) from chat_requests where date between '2022-06-01' and '2022-06-30')
  end as pct_contact_type_by_month
from contact_type_by_month
order by contact_type desc, pct_contact_type_by_month
-- June phone contact increased by ~6%. The ~6% was taken directly from chat. Email rate stayed about the same.
;
-- Type of customer that reached out
with phone_contact as
(
select profileId, date_diff(date(dsaEvent.eventDatetime), subscription_created_datetime, day) as days_since_subscribed, reviewType, reviewText, date(dsaEvent.eventDatetime) as message_date,
from `rental-prod.nuuly_messages.cx_reviews_messages`, unnest(questions) questions, unnest(reviewText) as reviewText 
left join `rental-prod.nuuly_reporting.customer_profile` on account_id = profileId
where questions.reviewType = 'contact-method' and reviewText = 'phone' and date(dsaEvent.eventDatetime) between '2022-05-01' and '2022-06-30'
order by message_date  
)
, customer_subscribe_length as
(
select
case
  when days_since_subscribed > 92 and message_date between '2022-05-01' and '2022-05-31' then 'may_more_than_4_months' 
  when days_since_subscribed between 62 and 91 and message_date between '2022-05-01' and '2022-05-31' then 'may_3_months' 
  when days_since_subscribed between 32 and 61 and message_date between '2022-05-01' and '2022-05-31' then 'may_2_months'
  when days_since_subscribed between 0 and 31 and message_date between '2022-05-01' and '2022-05-31' then 'may_less_than_1_months'
  when days_since_subscribed > 92 and message_date between '2022-06-01' and '2022-06-30' then 'june_more_than_4_months' 
  when days_since_subscribed between 62 and 91 and message_date between '2022-06-01' and '2022-06-30' then 'june_3_months' 
  when days_since_subscribed between 32 and 61 and message_date between '2022-06-01' and '2022-06-30' then 'june_2_months'
  when days_since_subscribed between 0 and 31 and message_date between '2022-06-01' and '2022-06-30' then 'june_1_months'
end as customer_type, 
count(profileId) as num_cust
from phone_contact
group by customer_type  
)
select customer_type, num_cust,
case
  when customer_type like '%may%' then num_cust/(select count(profileId) from phone_contact where message_date between '2022-05-01' and '2022-05-31')
  when customer_type like '%june%' then num_cust/(select count(profileId) from phone_contact where message_date between '2022-06-01' and '2022-06-30')
end as pct_from_group
from customer_subscribe_length
order by customer_type desc, pct_from_group desc
